<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head th:replace="fragments :: page_head('Home - Shopwise Website', 'none')" />
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/css/index.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/navbar.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/footer.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/home.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/detail_product.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnify/2.3.3/css/magnify.min.css" />

</head>
<body>
<div th:replace="fragments/navbar_fragment :: navbar"></div>
<div class="main-content">
    <div class="detail-wrapper d-flex justify-content-center">
        <div class="detail-zoom d-flex justify-content-center align-items-center position-relative">
            <div class="detail-zoom-magnifier d-flex justify-content-center align-items-center position-relative">
                <img class="detail-zoom-img" th:src="${product.image}" th:data-magnify-src="${product.image}"/>
            </div>
        </div>
        <div class="detail-summary">
            <div class="detail-summary-name" th:text="${product.name}"></div>
            <div class="d-flex align-items-center">
                <th:block th:if="${product.discount > 0}">
                    <div class="d-flex align-items-center" style="font-size: 16px; text-decoration: line-through; margin-right: 5px; color: #babbc1;">
                        <div th:replace="fragments :: format_currency(${product.price})"></div>
                        <span>₫</span>
                    </div>
                </th:block>
                <div class="detail-summary-price d-flex align-items-center">
                    <div th:replace="fragments :: format_currency(${product.getDiscountPrice()})"></div>
                    <span>₫</span>
                </div>
            </div>
            <div class="detail-summary-brand d-flex align-items-center">
                <h2 class="brand-title">Thương hiệu:</h2>
                <div class="brand-item">
                    <img th:src="${product.brands.logo}"/>
                </div>
            </div>
            <div class="detail-summary-short-desc" th:text="${product.shortDescription}"></div>
            <div class="detail-summary-policy">
                <ul class="detail-summary-policy-list">
                    <li>
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M899.6 276.5L705 396.4 518.4 147.5a8.06 8.06 0 0 0-12.9 0L319 396.4 124.3 276.5c-5.7-3.5-13.1 1.2-12.2 7.9L188.5 865c1.1 7.9 7.9 14 16 14h615.1c8 0 14.9-6 15.9-14l76.4-580.6c.8-6.7-6.5-11.4-12.3-7.9zm-126 534.1H250.3l-53.8-409.4 139.8 86.1L512 252.9l175.7 234.4 139.8-86.1-53.9 409.4zM512 509c-62.1 0-112.6 50.5-112.6 112.6S449.9 734.2 512 734.2s112.6-50.5 112.6-112.6S574.1 509 512 509zm0 160.9c-26.6 0-48.2-21.6-48.2-48.3 0-26.6 21.6-48.3 48.2-48.3s48.2 21.6 48.2 48.3c0 26.6-21.6 48.3-48.2 48.3z"></path>
                        </svg>
                        Thời gian giao hàng ước tính 14-30 ngày
                    </li>
                    <li>
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.4 124C290.5 124.3 112 303 112 523.9c0 128 60.2 242 153.8 315.2l-37.5 48c-4.1 5.3-.3 13 6.3 12.9l167-.8c5.2 0 9-4.9 7.7-9.9L369.8 727a8 8 0 0 0-14.1-3L315 776.1c-10.2-8-20-16.7-29.3-26a318.64 318.64 0 0 1-68.6-101.7C200.4 609 192 567.1 192 523.9s8.4-85.1 25.1-124.5c16.1-38.1 39.2-72.3 68.6-101.7 29.4-29.4 63.6-52.5 101.7-68.6C426.9 212.4 468.8 204 512 204s85.1 8.4 124.5 25.1c38.1 16.1 72.3 39.2 101.7 68.6 29.4 29.4 52.5 63.6 68.6 101.7 16.7 39.4 25.1 81.3 25.1 124.5s-8.4 85.1-25.1 124.5a318.64 318.64 0 0 1-68.6 101.7c-7.5 7.5-15.3 14.5-23.4 21.2a7.93 7.93 0 0 0-1.2 11.1l39.4 50.5c2.8 3.5 7.9 4.1 11.4 1.3C854.5 760.8 912 649.1 912 523.9c0-221.1-179.4-400.2-400.6-399.9z"></path>
                        </svg>Chính sách hoàn trả trong 30 ngày
                    </li>
                    <li>
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-792 72h752v120H136V232zm752 560H136V440h752v352zm-237-64h165c4.4 0 8-3.6 8-8v-72c0-4.4-3.6-8-8-8H651c-4.4 0-8 3.6-8 8v72c0 4.4 3.6 8 8 8z"></path>
                        </svg>
                        Thanh toán khi nhận hàng
                    </li>
                </ul>
            </div>
            <div style="color: white; padding-bottom: 10px">
                Số lượng còn: <span th:text="${product.inStock}"></span>
            </div>
            <div class="detail-summary-tool">
                <form th:action="@{'/cart/add'}" method="post" id="add-cart-form">
                    <div class="d-flex align-items-center" style="gap: 20px">
                        <input type="hidden" name="productId" th:value="${product.id}">
                        <div class="detail-summary-wrapper-qlt d-flex">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepDown()" type="button"></button>
                            <input type="number" name="quantity" min="1"  class="detail-summary-qlt input-number-qlt" value="1" th:max="${product.inStock}" onchange="handleInputNumber(event)"/>
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepUp()" class="plus" type="button"></button>
                        </div>
                        <button sec:authorize="isAuthenticated()" class="detail-summary-btn" type="submit">Add To Cart</button>
                        <button sec:authorize="isAnonymous()" class="detail-summary-btn" th:onclick="showErrorLoginPage()" type="button">Add To Cart</button>
                        <div class="detail-summary-tool-wishlist d-flex align-items-center justify-content-center position-relative" aria-label="Add To Wishlist">
                            <i class="far fa-heart"></i>
                        </div>
                    </div>
                </form>
            </div>
            <div class="detail-summary-meta d-flex flex-column">
                <div class="detail-summary-meta-categories">
                    Danh mục: <span class="meta-data" th:text="${product.categories.name}"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="detail-tabs">
        <div class="detail-tabs-header d-flex justify-content-center">
            <button class="detail-tabs-button tab-description tab-active" onclick="openTabs('tab-description')">Description</button>
            <button class="detail-tabs-button tab-review" onclick="openTabs('tab-review')">Reviews</button>
        </div>
        <div id="tab-description" class="tab-item">
            <div th:utext="${product.description}">

            </div>
        </div>

        <div id="tab-review" class="tab-item" style="display:none">
            <div class="tab-review-wrapper d-flex justify-content-between">
                <div class="tab-review-comment">
                    <ul class="tab-review-comment-list">
                        <th:block th:each="review : ${listReviews}">
                            <li class="tab-review-comment-item d-flex">
                                <div class="tab-review-comment-avatar">
                                    <div class="reviewer-avatar">
                                        <img src="https://res.cloudinary.com/dmriwkfll/image/upload/v1650937333/user_tz4efy.png"/>
                                    </div>
                                </div>
                                <div class="tab-review-comment-main">
                                    <div class="tab-review-comment-name" style="text-transform: capitalize" th:text="${review.user.firstName + ' ' + review.user.lastName}"></div>
                                    <div class="d-flex tab-review-comment-stars">
                                        <ul class="list-stars">
                                            <th:block th:each="star: ${#numbers.sequence(0, review.vote - 1)}">
                                                <li><i class="fas fa-star" style="color: #f7bc3d;"></i></li>
                                            </th:block>
                                            <th:block th:if="${(5 - review.vote) != 0}" th:each="star: ${#numbers.sequence(0, 5 - review.vote - 1)}">
                                                <li><i class="fas fa-star"></i></li>
                                            </th:block>
                                        </ul>
                                    </div>
                                    <div class="tab-review-comment-text" th:text="${review.comment}"></div>
                                    <div class="d-flex align-items-center" style="gap: 20px">
                                        <div class="tab-review-comment-date" th:text="${#dates.format(review.date, 'dd/MM/yyyy')}" ></div>
                                        <th:block sec:authorize="isAuthenticated()" >
                                            <div class="d-flex align-items-center" style="gap: 10px">
                                                <a  style="font-size: 12px; cursor: pointer; text-decoration: underline"
                                                    th:href="@{'/product/review/edit/' + ${product.id} + '/' + ${review.id}}"
                                                    data-toggle="tooltip"
                                                    data-placement="top"
                                                    title="Edit">
                                                    Sửa
                                                </a>
                                                <a  style="font-size: 12px; cursor: pointer; text-decoration: underline"
                                                    th:id="'link-delete-' + ${review.id}"
                                                    th:onclick="'showConfirmDelete(event,' + ${review.id} + ')'"
                                                    entity="review" th:href="@{'/product/review/delete/' + ${product.id} + '/' + ${review.id}}"
                                                    data-toggle="tooltip"
                                                    data-placement="top"
                                                    title="Delete">
                                                    Xoá
                                                </a>
                                            </div>
                                        </th:block>
                                    </div>
                                </div>
                            </li>
                        </th:block>
                        <th:block th:if="${listReviews == null || listReviews.empty}">
                            <div style="margin-left: 80px; margin-bottom: 20px; font-size: 18px;font-weight: 700">Hiện tại sản phẩm chưa có đánh giá nào!</div>
                        </th:block>
                    </ul>
                    <th:block sec:authorize="isAuthenticated()">
                        <th:block th:if="${isUserBuyProduct != null && isUserBuyProduct == true}">
                            <div class="tab-review-comment-write d-flex">
                                <div class="tab-review-comment-avatar">
                                    <div class="reviewer-avatar">
                                        <img th:src="@{/images/money.png}"/>
                                    </div>
                                </div>
                                <div class="tab-review-comment-main">
                                        <form th:action="@{'/product/review'}" th:object="${review}" method="post" id="form-review">
                                            <input type="hidden" name="productId" th:value="${product.id}" />
                                            <input type="hidden" name="id" th:field="*{id}" />
                                            <div class="d-flex flex-column tab-review-comment-stars">
                                                <div class="rating">
                                                    <input type="radio" name="vote" th:field="*{vote}" value="5" id="rating-5" required>
                                                    <label for="rating-5"><i class="fas fa-star"></i></label>
                                                    <input type="radio" name="vote" th:field="*{vote}" value="4" id="rating-4">
                                                    <label for="rating-4"><i class="fas fa-star"></i></label>
                                                    <input type="radio" name="vote" th:field="*{vote}" value="3" id="rating-3">
                                                    <label for="rating-3"><i class="fas fa-star"></i></label>
                                                    <input type="radio" name="vote" th:field="*{vote}" value="2" id="rating-2">
                                                    <label for="rating-2"><i class="fas fa-star"></i></label>
                                                    <input type="radio" name="vote" th:field="*{vote}" value="1" id="rating-1">
                                                    <label for="rating-1"><i class="fas fa-star"></i></label>
                                                </div>
                                                <span style="margin-left: 0 !important;" th:if="${#fields.hasErrors('vote')}" th:errors="*{vote}"  class="form-valid-feedback"></span>
                                            </div>
                                            <textarea class="form-control" id="review-comment" th:field="*{comment}" rows="4" placeholder="Viết đánh giá sản phẩm..." required></textarea>
                                            <span style="margin-left: 0 !important;" th:if="${#fields.hasErrors('comment')}" th:errors="*{comment}"  class="form-valid-feedback"></span>

                                            <button class="btn-submit-review" type="submit">Gửi</button>
                                        </form>

                                </div>
                            </div>
                        </th:block>
                    </th:block>

                </div>
                <div class="tab-review-result">
                    <div class="tab-review-result-ovg d-flex align-items-center">
                        <div class="tab-review-result-point" th:text="${overall == 0 ? '0' : overall}"></div>
                        <div class="tab-review-result-stars d-flex flex-column">
                            <ul class="list-stars">
                                <th:block th:if="${overall != 0}">
                                    <th:block th:each="star: ${#numbers.sequence(0, T(Math).round(overall) - 1)}">
                                        <li><i class="fas fa-star" style="color: #f7bc3d;"></i></li>
                                    </th:block>
                                    <th:block th:if="${(5 - T(Math).round(overall)) != 0}" th:each="star: ${#numbers.sequence(0, 5 - T(Math).round(overall) - 1)}">
                                        <li><i class="fas fa-star"></i></li>
                                    </th:block>
                                </th:block>
                                <th:block th:if="${overall == 0}">
                                    <th:block th:each="i : ${#numbers.sequence(0,4)}">
                                        <li><i class="fas fa-star"></i></li>
                                    </th:block>
                                </th:block>

                            </ul>
                            <div><span th:text="${totalItems}"></span> đánh giá</div>
                        </div>
                    </div>
                    <div class="tab-review-process d-flex align-items-center">
                        <span class="d-flex align-items-center flex-shrink-0">5 <i class="fas fa-star"></i></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width:' + ${((0.0 + countStarFive) / totalItems) * 100} + '%'"  th:aria-valuenow="${((0.0 + countStarFive) / totalItems) * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span th:text="${countStarFive}"></span>
                    </div>
                    <div class="tab-review-process d-flex align-items-center">
                        <span class="d-flex align-items-center flex-shrink-0">4 <i class="fas fa-star"></i></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width:' + ${((0.0 + countStarFour) / totalItems) * 100} + '%'"  th:aria-valuenow="${((0.0 + countStarFour) / totalItems) * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span th:text="${countStarFour}"></span>
                    </div>
                    <div class="tab-review-process d-flex align-items-center">
                        <span class="d-flex align-items-center flex-shrink-0">3 <i class="fas fa-star"></i></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width:' + ${((0.0 + countStarThree) / totalItems) * 100} + '%'"  th:aria-valuenow="${((0.0 + countStarThree) / totalItems) * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span th:text="${countStarThree}"></span>
                    </div>
                    <div class="tab-review-process d-flex align-items-center">
                        <span class="d-flex align-items-center flex-shrink-0">2 <i class="fas fa-star"></i></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width:' + ${((0.0 + countStarTwo) / totalItems) * 100} + '%'"  th:aria-valuenow="${((0.0 + countStarTwo) / totalItems) * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span th:text="${countStarTwo}"></span>
                    </div>
                    <div class="tab-review-process d-flex align-items-center">
                        <span class="d-flex align-items-center flex-shrink-0">1 <i class="fas fa-star"></i></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width:' + ${((0.0 + countStarOne) / totalItems) * 100} + '%'"  th:aria-valuenow="${((0.0 + countStarOne) / totalItems) * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span th:text="${countStarOne}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div th:replace="fragments/footer_fragment :: footer"></div>

<script type="text/javascript" th:src="@{/webjars/jquery/jquery.min.js}" ></script>
<script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/js/index.js}" ></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnify/2.3.3/js/jquery.magnify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.4/dist/sweetalert2.all.min.js"></script>

<script th:inline="javascript">
    $(document).ready(function() {
        $('.detail-zoom-img').magnify();
        let messageError = [[${messageError}]];
        let messageSuccess = [[${messageSuccess}]];
        let isReview = [[${isReview}]]
        let isUserBuyProduct = [[${isUserBuyProduct}]]

        if(isReview != null && isReview == true) {
            openTabs('tab-review');
        }
        if(messageSuccess) {
            Swal.fire({
                title: '',
                text: messageSuccess,
                icon: 'success',
                confirmButtonColor: '#3085d6'
            })
        }
        if(messageError ) {
            Swal.fire({
                title: '',
                text: messageError,
                icon: 'error'
            })
        }

    })

</script>
<script>
    function openTabs(tabName) {
        let i;
        let tabItem;
        let x = document.getElementsByClassName("tab-item");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none";
        }
        tabItem = document.getElementsByClassName("detail-tabs-button");
        for (i = 0; i < x.length; i++) {
            tabItem[i].className = tabItem[i].className.replace(" tab-active", "");
        }
        document.getElementById(tabName).style.display = "block";
        $("."+ tabName).addClass(" tab-active")
    }
</script>
</body>

